#include <stdlib.h>
#include <math.h>
#include <string.h>

#include <stm32_dsp.h>

#include "global.h"

#ifdef HAS_SOUND_FFT_SRC

static volatile uint16_t scanBufferDMA[FFT_SIZE*3];

#if FFT_SIZE == 1024
	static const uint16_t hammingWindow[1024]={2186,2186,2187,2189,2191,2193,2196,2200,2204,2209,2215,2221,2227,2234,2242,2250,2259,2269,2279,2289,2300,2312,2324,2337,2350,2364,2379,2394,2409,2426,2442,2460,2477,2496,2515,2534,2554,2575,2596,2618,2640,2663,2687,2711,2735,2760,2786,2812,2839,2866,2894,2922,2951,2981,3011,3041,3072,3104,3136,3169,3202,3235,3270,3305,3340,3376,3412,3449,3486,3524,3563,3602,3641,3681,3722,3763,3804,3847,3889,3932,3976,4020,4064,4110,4155,4201,4248,4295,4342,4390,4439,4488,4538,4588,4638,4689,4740,4792,4845,4897,4951,5005,5059,5113,5169,5224,5280,5337,5394,5451,5509,5567,5626,5685,5745,5805,5866,5927,5988,6050,6112,6175,6238,6301,6365,6429,6494,6559,6625,6691,6757,6824,6891,6959,7027,7095,7164,7233,7302,7372,7442,7513,7584,7655,7727,7799,7871,7944,8017,8090,8164,8238,8313,8388,8463,8539,8614,8691,8767,8844,8921,8998,9076,9154,9233,9311,9390,9470,9549,9629,9709,9790,9871,9952,10033,10114,10196,10278,10361,10443,10526,10609,10693,10777,10860,10945,11029,11114,11198,11284,11369,11454,11540,11626,11712,11799,11885,11972,12059,12146,12234,12321,12409,12497,12585,12674,12762,12851,12940,13029,13118,13207,13297,13387,13476,13566,13656,13747,13837,13927,14018,14109,14200,14291,14382,14473,14564,14656,14747,14839,14930,15022,15114,15206,15298,15390,15482,15575,15667,15759,15852,15944,16037,16129,16222,16315,16407,16500,16593,16686,16779,16872,16964,17057,17150,17243,17336,17429,17522,17615,17708,17800,17893,17986,18079,18172,18264,18357,18450,18542,18635,18728,18820,18912,19005,19097,19189,19281,19374,19466,19557,19649,19741,19833,19924,20016,20107,20198,20289,20380,20471,20562,20653,20743,20834,20924,21014,21104,21194,21284,21373,21463,21552,21641,21730,21819,21908,21996,22084,22172,22260,22348,22435,22523,22610,22697,22783,22870,22956,23042,23128,23214,23299,23385,23470,23554,23639,23723,23807,23891,23974,24058,24141,24224,24306,24388,24470,24552,24633,24715,24795,24876,24956,25036,25116,25196,25275,25354,25432,25510,25588,25666,25743,25820,25897,25973,26049,26125,26200,26275,26350,26424,26498,26572,26645,26718,26791,26863,26935,27006,27077,27148,27219,27289,27358,27428,27496,27565,27633,27701,27768,27835,27902,27968,28033,28099,28164,28228,28292,28356,28419,28482,28545,28607,28668,28729,28790,28850,28910,28970,29029,29087,29145,29203,29260,29317,29373,29429,29485,29539,29594,29648,29702,29755,29807,29859,29911,29962,30013,30063,30113,30162,30211,30259,30307,30354,30401,30447,30493,30539,30583,30628,30672,30715,30758,30800,30842,30883,30924,30964,31004,31043,31082,31120,31158,31195,31232,31268,31303,31338,31373,31407,31440,31473,31506,31538,31569,31600,31630,31660,31689,31718,31746,31773,31800,31827,31852,31878,31903,31927,31951,31974,31996,32018,32040,32061,32081,32101,32120,32139,32157,32175,32192,32208,32224,32239,32254,32268,32282,32295,32308,32320,32331,32342,32352,32362,32371,32379,32387,32395,32402,32408,32414,32419,32423,32427,32431,32434,32436,32438,32439,32439,32439,32439,32438,32436,32434,32431,32427,32423,32419,32414,32408,32402,32395,32387,32379,32371,32362,32352,32342,32331,32320,32308,32295,32282,32268,32254,32239,32224,32208,32192,32175,32157,32139,32120,32101,32081,32061,32040,32018,31996,31974,31951,31927,31903,31878,31852,31827,31800,31773,31746,31718,31689,31660,31630,31600,31569,31538,31506,31473,31440,31407,31373,31338,31303,31268,31232,31195,31158,31120,31082,31043,31004,30964,30924,30883,30842,30800,30758,30715,30672,30628,30583,30539,30493,30447,30401,30354,30307,30259,30211,30162,30113,30063,30013,29962,29911,29859,29807,29755,29702,29648,29594,29539,29485,29429,29373,29317,29260,29203,29145,29087,29029,28970,28910,28850,28790,28729,28668,28607,28545,28482,28419,28356,28292,28228,28164,28099,28033,27968,27902,27835,27768,27701,27633,27565,27496,27428,27358,27289,27219,27148,27077,27006,26935,26863,26791,26718,26645,26572,26498,26424,26350,26275,26200,26125,26049,25973,25897,25820,25743,25666,25588,25510,25432,25354,25275,25196,25116,25036,24956,24876,24795,24715,24633,24552,24470,24388,24306,24224,24141,24058,23974,23891,23807,23723,23639,23554,23470,23385,23299,23214,23128,23042,22956,22870,22783,22697,22610,22523,22435,22348,22260,22172,22084,21996,21908,21819,21730,21641,21552,21463,21373,21284,21194,21104,21014,20924,20834,20743,20653,20562,20471,20380,20289,20198,20107,20016,19924,19833,19741,19649,19557,19466,19374,19281,19189,19097,19005,18912,18820,18728,18635,18542,18450,18357,18264,18172,18079,17986,17893,17800,17708,17615,17522,17429,17336,17243,17150,17057,16964,16872,16779,16686,16593,16500,16407,16315,16222,16129,16037,15944,15852,15759,15667,15575,15482,15390,15298,15206,15114,15022,14930,14839,14747,14656,14564,14473,14382,14291,14200,14109,14018,13927,13837,13747,13656,13566,13476,13387,13297,13207,13118,13029,12940,12851,12762,12674,12585,12497,12409,12321,12234,12146,12059,11972,11885,11799,11712,11626,11540,11454,11369,11284,11198,11114,11029,10945,10860,10777,10693,10609,10526,10443,10361,10278,10196,10114,10033,9952,9871,9790,9709,9629,9549,9470,9390,9311,9233,9154,9076,8998,8921,8844,8767,8691,8614,8539,8463,8388,8313,8238,8164,8090,8017,7944,7871,7799,7727,7655,7584,7513,7442,7372,7302,7233,7164,7095,7027,6959,6891,6824,6757,6691,6625,6559,6494,6429,6365,6301,6238,6175,6112,6050,5988,5927,5866,5805,5745,5685,5626,5567,5509,5451,5394,5337,5280,5224,5169,5113,5059,5005,4951,4897,4845,4792,4740,4689,4638,4588,4538,4488,4439,4390,4342,4295,4248,4201,4155,4110,4064,4020,3976,3932,3889,3847,3804,3763,3722,3681,3641,3602,3563,3524,3486,3449,3412,3376,3340,3305,3270,3235,3202,3169,3136,3104,3072,3041,3011,2981,2951,2922,2894,2866,2839,2812,2786,2760,2735,2711,2687,2663,2640,2618,2596,2575,2554,2534,2515,2496,2477,2460,2442,2426,2409,2394,2379,2364,2350,2337,2324,2312,2300,2289,2279,2269,2259,2250,2242,2234,2227,2221,2215,2209,2204,2200,2196,2193,2191,2189,2187,2186,2186};
#elif FFT_SIZE == 256
	static const uint16_t hammingWindow[256]={2186,2191,2205,2228,2260,2301,2351,2411,2479,2557,2643,2738,2843,2956,3077,3208,3347,3494,3650,3814,3986,4166,4355,4551,4755,4967,5186,5412,5646,5886,6134,6389,6650,6917,7191,7471,7757,8049,8346,8649,8957,9271,9589,9911,10239,10570,10906,11245,11589,11935,12285,12638,12994,13353,13714,14077,14442,14809,15177,15546,15917,16289,16661,17033,17406,17779,18151,18523,18894,19264,19633,20001,20367,20731,21093,21452,21810,22164,22516,22864,23209,23550,23888,24222,24551,24876,25197,25512,25823,26128,26429,26723,27012,27295,27572,27843,28107,28365,28616,28860,29098,29328,29550,29766,29974,30174,30366,30550,30727,30895,31055,31206,31349,31484,31610,31728,31836,31936,32027,32109,32182,32246,32301,32346,32383,32411,32429,32438,32438,32429,32411,32383,32346,32301,32246,32182,32109,32027,31936,31836,31728,31610,31484,31349,31206,31055,30895,30727,30550,30366,30174,29974,29766,29550,29328,29098,28860,28616,28365,28107,27843,27572,27295,27012,26723,26429,26128,25823,25512,25197,24876,24551,24222,23888,23550,23209,22864,22516,22164,21810,21452,21093,20731,20367,20001,19633,19264,18894,18523,18151,17779,17406,17033,16661,16289,15917,15546,15177,14809,14442,14077,13714,13353,12994,12638,12285,11935,11589,11245,10906,10570,10239,9911,9589,9271,8957,8649,8346,8049,7757,7471,7191,6917,6650,6389,6134,5886,5646,5412,5186,4967,4755,4551,4355,4166,3986,3814,3650,3494,3347,3208,3077,2956,2843,2738,2643,2557,2479,2411,2351,2301,2260,2228,2205,2191,2186};
#elif FFT_SIZE == 64
	static const uint16_t hammingWindow[64]={2186,2261,2486,2858,3374,4028,4815,5725,6751,7882,9106,10412,11786,13216,14686,16182,17690,19194,20679,22130,23534,24876,26143,27322,28401,29371,30220,30941,31527,31972,32270,32421,32421,32270,31972,31527,30941,30220,29371,28401,27322,26143,24876,23534,22130,20679,19194,17690,16182,14686,13216,11786,10412,9106,7882,6751,5725,4815,4028,3374,2858,2486,2261,2186};
#endif

#define ADC_INITED_FLAG 7834
static volatile uint16_t adcInited;

void soundFFT_init() {
	memset((void*)scanBufferDMA, 0, sizeof(scanBufferDMA));
	RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1, ENABLE);
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_ADC1, ENABLE);

	//-------------------------------
	GPIO_InitTypeDef GPIO_InitStructure;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
	GPIO_InitStructure.GPIO_Pin = SOUND_IN_PIN;
	GPIO_Init(SOUND_IN_PORT, &GPIO_InitStructure);
	//-------------------------------
	// RCC_ADCCLKConfig(RCC_PCLK2_Div6);     //ADCCLK = PCLK2/6 = 12MHz
	ADC_DeInit(ADC1);
	ADC_InitTypeDef ADC_InitStructure;
	ADC_InitStructure.ADC_Mode = ADC_Mode_Independent;
	ADC_InitStructure.ADC_ScanConvMode = DISABLE;
	ADC_InitStructure.ADC_ContinuousConvMode = ENABLE;
	ADC_InitStructure.ADC_ExternalTrigConv = ADC_ExternalTrigConv_None;
	ADC_InitStructure.ADC_DataAlign = ADC_DataAlign_Right;
	ADC_InitStructure.ADC_NbrOfChannel = 1;
	ADC_Init(ADC1, &ADC_InitStructure);

	ADC_RegularChannelConfig(ADC1, SOUND_IN_ADC1_CHANEL, 1, SOUND_IN_SAMPLE_TIME);
	ADC_Cmd(ADC1, ENABLE);
	ADC_ResetCalibration(ADC1);
	while(ADC_GetResetCalibrationStatus(ADC1));
	ADC_StartCalibration(ADC1);
	while(ADC_GetCalibrationStatus(ADC1));
	//-------------------------------

	NVIC_InitTypeDef NVIC_InitStructure;
	NVIC_InitStructure.NVIC_IRQChannel = DMA1_Channel1_IRQn;
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 3;
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
	NVIC_Init(&NVIC_InitStructure);

	adcInited = ADC_INITED_FLAG;
//	USART_DBG_printf("\nADC_INITED");
}

static volatile uint8_t busy_scan_result = FALSE;
volatile uint16_t scan_result[FFT_SIZE];

void DMA1_Channel1_IRQHandler(void) {
//	USART_DBG_printf("\nDMA1_IT_TC1 [%d]", _sysTicks);
	if(DMA_GetITStatus(DMA1_IT_TC1)) {
		DMA_ClearITPendingBit(DMA1_IT_GL1);
		DMA_ITConfig(DMA1_Channel1, DMA_IT_TC, DISABLE);
		ADC_DMACmd(ADC1, DISABLE);
		ADC_Cmd(ADC1, DISABLE);
		busy_scan_result = TRUE;
		for(int i = 0; i < FFT_SIZE; i++) {
			// shift freq.
			scan_result[i] = (
					(uint32_t)scanBufferDMA[i*3]+
					(uint32_t)scanBufferDMA[i*3+1]+
					(uint32_t)scanBufferDMA[i*3+2])/3;
		}
		busy_scan_result = FALSE;
	}
}


uint16_t* soundFFT_result() {
	// Complex input vector: real part = ADC, complex = 0
	static volatile uint32_t fft_out[FFT_SIZE];
	static volatile uint16_t soundFFT_result[FFT_RESULT_SIZE];
	static volatile uint32_t fft_in[FFT_SIZE];


	while(busy_scan_result) {}
	__disable_irq();
	for(int i = 0; i < FFT_SIZE; i++) {
		fft_in[i] = (uint32_t)scan_result[i] * hammingWindow[i];
		fft_in[i] /= 0x7FFF;
	}
	__enable_irq();

	FFT_CALC((void*)fft_out, (void*)fft_in, FFT_SIZE);
	for(int i = 0; i < FFT_RESULT_SIZE; i++) {
		float re = ((int16_t)fft_out[i]);
		float im = ((int16_t)(fft_out[i] >> 16));
		float magn = sqrt(re*re+im*im);
		if(i > 220) {
			magn *= 1.95;
		} else if(i > (FFT_RESULT_SIZE-FFT_RESULT_SIZE/8)) {
			magn *= 1.85;
		} else if(i > (FFT_RESULT_SIZE-FFT_RESULT_SIZE/6)) {
			magn *= 1.8;
		} else if(i > (FFT_RESULT_SIZE-FFT_RESULT_SIZE/4)) {
			magn *= 1.7;
		} else if(i > (FFT_RESULT_SIZE-FFT_RESULT_SIZE/2)) {
			magn *= 1.5;
		}
		soundFFT_result[i] = (uint16_t)magn;
	}
	return (uint16_t*)soundFFT_result;
}


void soundFFT_startADC() {
	if(adcInited != ADC_INITED_FLAG) return;

	DMA_InitTypeDef DMA_InitStructure;
	DMA_StructInit(&DMA_InitStructure);
	DMA_DeInit(DMA1_Channel1);
	DMA_InitStructure.DMA_PeripheralBaseAddr = (uint32_t)&(((ADC_TypeDef*)ADC1_BASE)->DR);
	DMA_InitStructure.DMA_MemoryBaseAddr = (uint32_t)scanBufferDMA;
	DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralSRC;
	DMA_InitStructure.DMA_BufferSize = FFT_SIZE*3;
	DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Disable;
	DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable;
	DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord; // 16 bit
	DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord; //16 bit
	DMA_InitStructure.DMA_Mode = DMA_Mode_Normal;
	DMA_InitStructure.DMA_Priority = DMA_Priority_Low;
	DMA_InitStructure.DMA_M2M = DMA_M2M_Disable;
	DMA_Init(DMA1_Channel1, &DMA_InitStructure);
	DMA_Cmd(DMA1_Channel1, ENABLE);

	DMA_ITConfig(DMA1_Channel1, DMA_IT_TC, ENABLE);
	ADC_DMACmd(ADC1, ENABLE);
	ADC_Cmd(ADC1, ENABLE);
	ADC_SoftwareStartConvCmd(ADC1, ENABLE);

//	USART_DBG_printf("\nsoundFFT_startADC [%d] %d", _sysTicks, DMA_GetCurrDataCounter(DMA1_Channel2));
}


#endif // HAS_SOUND_FFT_SRC

